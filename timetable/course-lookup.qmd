---
title: "2026 Academic Timetable Course Lookup"
format: html
server: shiny
---

```{r}
#| context: setup
#| include: false

library(shiny)
library(jsonlite)
library(dplyr)
library(DT)

# Read the timetable data
timetable_data <- fromJSON("timetable_data.json")
timetable_df <- as.data.frame(timetable_data)

# Extract course prefixes and numbers for two-step selection
timetable_df$course_prefix <- substr(timetable_df$course, 1, 4)
timetable_df$course_number <- substr(timetable_df$course, 5, nchar(timetable_df$course))

# Get unique prefixes
unique_prefixes <- sort(unique(timetable_df$course_prefix))
```

```{r}
#| context: server

# Update course number choices based on prefix selection
observe({
  if (!is.null(input$course_prefix) && input$course_prefix != "") {
    available_numbers <- timetable_df %>%
      filter(course_prefix == input$course_prefix) %>%
      pull(course_number) %>%
      unique() %>%
      sort()
    
    updateSelectInput(session, "course_number",
                     choices = c("Select..." = "", available_numbers))
  }
})

# Clear dropdown selections when full course code is entered
observe({
  if (!is.null(input$full_course_code) && nchar(input$full_course_code) > 0) {
    updateSelectInput(session, "course_prefix", selected = "")
    updateSelectInput(session, "course_number", selected = "")
  }
})

# Clear full course code when dropdowns are used
observe({
  if (!is.null(input$course_prefix) && input$course_prefix != "") {
    updateTextInput(session, "full_course_code", value = "")
  }
})

# Get selected course from either method
selected_course <- reactive({
  # Priority to full course code input
  if (!is.null(input$full_course_code) && nchar(input$full_course_code) > 0) {
    return(toupper(trimws(input$full_course_code)))
  }
  
  # Otherwise use dropdown selection
  if (!is.null(input$course_prefix) && !is.null(input$course_number) && 
      input$course_prefix != "" && input$course_number != "") {
    return(paste0(input$course_prefix, input$course_number))
  }
  
  return(NULL)
})

# Course information header
output$course_header <- renderUI({
  course <- selected_course()
  if (!is.null(course)) {
    h3(paste("Course Information for", course))
  } else {
    h3("Enter a course code or select from dropdowns to view timetable information")
  }
})

# Display course information
output$course_info <- renderDT({
  selected_course_code <- selected_course()
  req(selected_course_code)
  
  course_data <- timetable_df %>%
    filter(course == selected_course_code) %>%
    select(crn, type, stu, dates, room, start, finish, days) %>%
    rename(
      CRN = crn,
      Type = type,
      Students = stu,
      Dates = dates,
      Room = room,
      Start = start,
      Finish = finish,
      Days = days
    )
  
  if (nrow(course_data) > 0) {
    datatable(course_data, 
             options = list(
               dom = 't',
               pageLength = -1,
               scrollX = TRUE,
               columnDefs = list(
                 list(targets = 3, width = '120px')
               )
             ),
             rownames = FALSE)
  } else {
    data.frame(Message = "No course information found. Please check the course code.")
  }
})
```

## Course Lookup

```{r}
#| echo: false

# Sidebar with inputs
div(class = "row",
  div(class = "col-md-3",
    wellPanel(
      h4("Find Course"),
      
      # Option 1: Quick search by full course code
      textInput("full_course_code", 
               "Enter Full Course Code:", 
               placeholder = "e.g., ACCY231 or mmpa502"),
      
      hr(),
      
      h5("OR Select Step by Step:"),
      
      # Option 2: Two-step selection
      selectInput("course_prefix", 
                 "Course Prefix:", 
                 choices = c("Select..." = "", unique_prefixes)),
      
      conditionalPanel(
        condition = "input.course_prefix != ''",
        selectInput("course_number", 
                   "Course Number:", 
                   choices = c("Select..." = ""))
      )
    )
  ),
  
  # Main panel with results
  div(class = "col-md-9",
    uiOutput("course_header"),
    DTOutput("course_info")
  )
)
```

## Instructions

**Two ways to find your course:**

**Option 1 - Quick Search:** Type the full course code directly (e.g., ACCY231, mmpa502, BILD101)

**Option 2 - Step by Step:**

1. **Select Course Prefix:** Choose the first four characters (e.g., ACCY, MMPA, BILD)  
2. **Select Course Number:** Choose from available numbers for that prefix

**Results show all sections for your course with:**

- **CRN:** Course Reference Number
- **Type:** Class type (Lecture, Tutorial, etc.)
- **Students:** Enrollment capacity
- **Dates:** When the course runs
- **Room:** Location
- **Start/Finish:** Class times
- **Days:** Days of the week the class meets

*Data from: 2026 Academic Timetable - DRAFT 1 - 20250827*